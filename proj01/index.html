<!doctype html>
<html>

<head>
<title>Marek's Tree Test</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 vColor;

    void main(void) {
        gl_FragColor = vColor;
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec4 aVertexColor;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec4 vColor;

    void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vColor = aVertexColor;
    }
</script>
<script type="text/javascript" src="webgl.js"></script>
<script type="text/javascript" src="trees.js"></script>
<script type="text/javascript">
//Test code
function makeTestParams()
{
   var params = new SegmentParameters();
   params.minSegmentLength = 1;
   params.maxSegmentLength = 2;
   params.minSegmentAngle = Math.PI / 16;
   params.maxSegmentAngle = Math.PI / 8;
   params.minNumBranches = 1;
   params.maxNumBranches = 4;
   params.segments = 9;
   params.branchLengthFactor = 2;
   params.branchAngleFactor = 1.5;
   params.branchSegmentFactor = 1;
   params.branchBranchFactor = .5;

   return params;
}

var segment;

function countNumSegments(segment){
   var output;
   if (segment.nextSegment != null)
   {
      output = countNumSegments(segment.nextSegment) + 1;
   } else {
      output = 1;
   }

   for (var branch in segment.branches)
   {
      output += countNumSegments(branch);      
   }

   return output;
}

function addSegmentToRenderable(vertexArray, elementArray, colorArray, rootIndexStart, templateVertices, segment, rootMatrix, level)
{
   var m = mat4.create();
   mat4.set(rootMatrix, m);

   var vUp = vec3.create();
   vUp.set([0,1,0], vUp);
   var vFor = vec3.create();
   vFor.set([Math.cos(segment.direction), 0, Math.sin(segment.direction)], vFor);
   var vRot = vec3.cross(vUp, vFor);

   //mat4.scale(m, [.7, 1, .7]);
   mat4.rotate(m, segment.angle, vRot);
   mat4.translate(m, [0, segment.segmentLength, 0]);

   var startIndex = vertexArray.length;

   var scaleMatrix = mat4.create();
   mat4.identity(scaleMatrix);
   mat4.scale(scaleMatrix, [Math.pow(.6, level), 1, Math.pow(.6, level)]);
   //Add vertices
   for (var i in templateVertices)
   {
      //Vertex Location
      var v = vec3.create(templateVertices[i]);
      v = mat4.multiplyVec3(scaleMatrix, v);
      v = mat4.multiplyVec3(m, v);
      vertexArray.push(v);

      //Color
      var c = Math.pow(.9, level);
      colorArray.push([c,c,c,1]);
   }

   //Elements
   for (var i = 0; i < templateVertices.length; i++)
   {
      elementArray.push(rootIndexStart + i);
      elementArray.push(startIndex + i);
   }
   //loop around
   elementArray.push(rootIndexStart);
   elementArray.push(startIndex);
   //Degenerate
   elementArray.push(startIndex);

   //Up first
   if (segment.nextSegment != null)
   {
      addSegmentToRenderable(vertexArray, elementArray, colorArray, startIndex, templateVertices, segment.nextSegment, m, level+1);
   } else {
      //TODO: Cap off
   }

   for (var branch in segment.branches)
   {
      //discontinuous degenerate
      elementArray.push(rootIndexStart);
      elementArray.push(rootIndexStart);
      addSegmentToRenderable(vertexArray, elementArray, colorArray, rootIndexStart, templateVertices, segment.branches[branch], rootMatrix, level);
   }
}

function unpackArray(input)
{
   var output = [];

   for (var child in input)
   {
      for (var i = 0; i < input[child].length; i++)
      {
         output.push(input[child][i]);
      }
   }

   return output;
}

   /*var templateVertices = [
      vec3.create([-1.0, 0.0, 0.0]),
      vec3.create([-0.5, 0.0, 0.5]),
      vec3.create([ 0.5, 0.0, 0.5]),
      vec3.create([ 1.0, 0.0, 0.0]),
      vec3.create([ 0.5, 0.0,-0.5]),
      vec3.create([-0.5, 0.0,-0.5])
   ];*/
function makeTemplateVertices()
{
   var templateVertices = [];

   for (var i = 0; i < 6; i++)
   {
      templateVertices.push(vec3.create([Math.cos(i * Math.PI / 3), 0, Math.sin(i * Math.PI / 3)]));
   }

   return templateVertices;
}

function makeSegmentRenderable2(segment, glContext)
{
   var templateVertices = makeTemplateVertices();

   var vertexArray = templateVertices.slice(0);
   var elementArray = [];
   var colorArray = [];
   //Initialize color array
   for (var i = 0; i < vertexArray.length; i++)
   {
      colorArray.push([1,1,1,1]);
   }
   var rootMatrix = mat4.create();
   mat4.identity(rootMatrix);

   var renderable = new Renderable(glContext);
   renderable.mvMatrix = rootMatrix;

   addSegmentToRenderable(vertexArray, elementArray, colorArray, 0, templateVertices, segment, rootMatrix, 0);

   var upColors = unpackArray(colorArray);
   var upVerts = unpackArray(vertexArray);
   var upElements = elementArray;
   var upColors = unpackArray(colorArray);

   renderable.setVertices(upVerts);
   renderable.setElements(upElements);
   renderable.setColors(upColors);

   return renderable;
}

var renderable;

function makeSegmentRenderable(segment, matrix, glContext)
{
   var renderable = makeTestRenderable(glContext);
   mat4.set(matrix, renderable.mvMatrix);
   var vUp = vec3.create();
   vec3.set([0, 1, 0], vUp);
   var vFor = vec3.create();
   vec3.set([Math.cos(segment.direction), 0.0, Math.sin(segment.direction)], vFor);

   var vRot = vec3.cross(vUp, vFor);
   mat4.translate(renderable.mvMatrix, [0.0, 1.0, 0.0]);
   mat4.rotate(renderable.mvMatrix, segment.angle, vRot);
   mat4.translate(renderable.mvMatrix, [0.0, 1.0, 0.0]);

   
   //Children
   for (var branch in segment.branches)
   {
      //var rBranch = makeSegmentRenderable(segment.branches[branch], renderable.mvMatrix, glContext);
      var rBranch = makeSegmentRenderable(segment.branches[branch], matrix, glContext);
      renderables.push(rBranch);
   }

   if (segment.nextSegment != null)
   {
      var rNext = makeSegmentRenderable(segment.nextSegment, renderable.mvMatrix, glContext);
      renderables.push(rNext);
   }

   mat4.scale(renderable.mvMatrix, [.1, 1, .1]);
   return renderable;
}

function makeTestRenderable(glContext)
{
   var output = new Renderable(glContext);

   var vertices = [
      // Front face
      -1.0, -1.0,  1.0,
      1.0, -1.0,  1.0,
      1.0,  1.0,  1.0,
      -1.0,  1.0,  1.0,

      // Back face
      -1.0, -1.0, -1.0,
      -1.0,  1.0, -1.0,
      1.0,  1.0, -1.0,
      1.0, -1.0, -1.0,

      // Top face
      -1.0,  1.0, -1.0,
      -1.0,  1.0,  1.0,
      1.0,  1.0,  1.0,
      1.0,  1.0, -1.0,

      // Bottom face
      -1.0, -1.0, -1.0,
      1.0, -1.0, -1.0,
      1.0, -1.0,  1.0,
      -1.0, -1.0,  1.0,

      // Right face
      1.0, -1.0, -1.0,
      1.0,  1.0, -1.0,
      1.0,  1.0,  1.0,
      1.0, -1.0,  1.0,

      // Left face
      -1.0, -1.0, -1.0,
      -1.0, -1.0,  1.0,
      -1.0,  1.0,  1.0,
      -1.0,  1.0, -1.0
   ];

   colors = [
      [1.0, 0.0, 0.0, 1.0], // Front face
      [1.0, 1.0, 0.0, 1.0], // Back face
      [0.0, 1.0, 0.0, 1.0], // Top face
      [1.0, 0.5, 0.5, 1.0], // Bottom face
      [1.0, 0.0, 1.0, 1.0], // Right face
      [0.0, 0.0, 1.0, 1.0]  // Left face
   ];
   var unpackedColors = [];
   for (var i in colors) {
      var color = colors[i];
      for (var j=0; j < 4; j++) {
         unpackedColors = unpackedColors.concat(color);
      }
   }

   var elements = [
      0, 1, 2,      0, 2, 3,    // Front face
      4, 5, 6,      4, 6, 7,    // Back face
      8, 9, 10,     8, 10, 11,  // Top face
      12, 13, 14,   12, 14, 15, // Bottom face
      16, 17, 18,   16, 18, 19, // Right face
      20, 21, 22,   20, 22, 23  // Left face
   ];

   output.setVertices(vertices);
   output.setColors(unpackedColors);
   output.setElements(elements);

   output.mvMatrix = mat4.create();
   mat4.identity(output.mvMatrix);

   return output;
}
</script>

<style>
body {
   background: #000;
}
canvas {
   display: block;
   margin: 0 auto;
   padding: 25px;
}
</style>
</head>


<body onload="webGLStart();">
    <canvas id="lesson04-canvas" style="border: none;" width="900" height="900"></canvas>
</body>

</html>
