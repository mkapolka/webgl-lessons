<!doctype html>
<html>

<head>
<title>Marek's Tree Test</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 vColor;

    void main(void) {
        gl_FragColor = vColor;
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec4 aVertexColor;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec4 vColor;

    void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vColor = aVertexColor;
    }
</script>
<script type="text/javascript" src="webgl.js"></script>
<script type="text/javascript" src="trees.js"></script>
<script type="text/javascript">
//Test code
function makeTestParams()
{
   var params = new SegmentParameters();
   params.minSegmentLength = 1;
   params.maxSegmentLength = 2;
   params.minSegmentAngle = Math.PI / 16;
   params.maxSegmentAngle = Math.PI / 4;
   params.minNumBranches = 1;
   params.maxNumBranches = 4;
   params.segments = 6;
   params.branchLengthFactor = 2;
   params.branchAngleFactor = .9;
   params.branchSegmentFactor = 1;
   params.branchBranchFactor = .5;

   return params;
}

var segment;

function countNumSegments(segment){
   var output;
   if (segment.nextSegment != null)
   {
      output = countNumSegments(segment.nextSegment) + 1;
   } else {
      output = 1;
   }

   for (var branch in segment.branches)
   {
      output += countNumSegments(branch);      
   }

   return output;
}

var renderable;

function makeSegmentRenderable(segment, matrix, glContext)
{
   var renderable = makeTestRenderable(glContext);
   mat4.set(matrix, renderable.mvMatrix);
   var vUp = vec3.create();
   vec3.set([0, 1, 0], vUp);
   var vFor = vec3.create();
   vec3.set([Math.cos(segment.direction), 0.0, Math.sin(segment.direction)], vFor);

   var vRot = vec3.cross(vUp, vFor);
   mat4.translate(renderable.mvMatrix, [0.0, 1.0, 0.0]);
   mat4.rotate(renderable.mvMatrix, segment.angle, vRot);
   mat4.translate(renderable.mvMatrix, [0.0, 1.0, 0.0]);

   
   //Children
   for (var branch in segment.branches)
   {
      //var rBranch = makeSegmentRenderable(segment.branches[branch], renderable.mvMatrix, glContext);
      var rBranch = makeSegmentRenderable(segment.branches[branch], matrix, glContext);
      renderables.push(rBranch);
   }

   if (segment.nextSegment != null)
   {
      var rNext = makeSegmentRenderable(segment.nextSegment, renderable.mvMatrix, glContext);
      renderables.push(rNext);
   }

   mat4.scale(renderable.mvMatrix, [.1, 1, .1]);
   return renderable;
}

function makeTestRenderable(glContext)
{
   var output = new Renderable(glContext);

   var vertices = [
      // Front face
      -1.0, -1.0,  1.0,
      1.0, -1.0,  1.0,
      1.0,  1.0,  1.0,
      -1.0,  1.0,  1.0,

      // Back face
      -1.0, -1.0, -1.0,
      -1.0,  1.0, -1.0,
      1.0,  1.0, -1.0,
      1.0, -1.0, -1.0,

      // Top face
      -1.0,  1.0, -1.0,
      -1.0,  1.0,  1.0,
      1.0,  1.0,  1.0,
      1.0,  1.0, -1.0,

      // Bottom face
      -1.0, -1.0, -1.0,
      1.0, -1.0, -1.0,
      1.0, -1.0,  1.0,
      -1.0, -1.0,  1.0,

      // Right face
      1.0, -1.0, -1.0,
      1.0,  1.0, -1.0,
      1.0,  1.0,  1.0,
      1.0, -1.0,  1.0,

      // Left face
      -1.0, -1.0, -1.0,
      -1.0, -1.0,  1.0,
      -1.0,  1.0,  1.0,
      -1.0,  1.0, -1.0
   ];

   colors = [
      [1.0, 0.0, 0.0, 1.0], // Front face
      [1.0, 1.0, 0.0, 1.0], // Back face
      [0.0, 1.0, 0.0, 1.0], // Top face
      [1.0, 0.5, 0.5, 1.0], // Bottom face
      [1.0, 0.0, 1.0, 1.0], // Right face
      [0.0, 0.0, 1.0, 1.0]  // Left face
   ];
   var unpackedColors = [];
   for (var i in colors) {
      var color = colors[i];
      for (var j=0; j < 4; j++) {
         unpackedColors = unpackedColors.concat(color);
      }
   }

   var elements = [
      0, 1, 2,      0, 2, 3,    // Front face
      4, 5, 6,      4, 6, 7,    // Back face
      8, 9, 10,     8, 10, 11,  // Top face
      12, 13, 14,   12, 14, 15, // Bottom face
      16, 17, 18,   16, 18, 19, // Right face
      20, 21, 22,   20, 22, 23  // Left face
   ];

   output.setVertices(vertices);
   output.setColors(unpackedColors);
   output.setElements(elements);

   output.mvMatrix = mat4.create();
   mat4.identity(output.mvMatrix);

   return output;
}

function test()
{
   var params = makeTestParams();

   segment = generateSegment(null, params);

   var m4 = mat4.create();
   mat4.identity(m4);
   mat4.translate(m4, [0, -2.7, -25.0]);
   var rr = makeSegmentRenderable(segment, m4, gl);
   //mat4.set(m4, rr.mvMatrix);
   mat4.identity(rr.mvMatrix);
   //mat4.scale(rr.mvMatrix, [.5, .5, .5]);
   renderables.push(rr);
}
</script>
</head>


<body onload="webGLStart();">
    <canvas id="lesson04-canvas" style="border: none;" width="500" height="500"></canvas>
</body>

</html>
